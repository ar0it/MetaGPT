<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.1">
<title>src.metagpt.predictors.predictor_network API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>src.metagpt.predictors.predictor_network</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork"><code class="flex name class">
<span>class <span class="ident">PredictorNetwork</span></span>
<span>(</span><span>raw_meta: str)</span>
</code></dt>
<dd>
<div class="desc"><p>This predictor approach uses two assistants, one for splitting the raw metadata into already contained and new metadata,
and one for predicting the structured annotations from the new metadata.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class PredictorNetwork(PredictorTemplate):
    &#34;&#34;&#34;
    This predictor approach uses two assistants, one for splitting the raw metadata into already contained and new metadata,
    and one for predicting the structured annotations from the new metadata.
    &#34;&#34;&#34;
    
    def __init__(self, raw_meta: str) -&gt; None:
        super().__init__()
        self.raw_metadata = raw_meta
        self.full_message = &#34;The raw data is: \n&#34; + str(self.raw_metadata)

        self.sep_prompt = &#34;&#34;&#34;
        You are part of a toolchain designed to predict metadata for the OME model, specifically the structured annotations part.
        You will be interacting with other toolchain components, therefore asking questions or providing any human-readable output is not necessary.
        Your task will be to take raw metadata in the form of key-value pairs and sort out the one that do not have an appropriate place in the ome datamodel,
        but instead need to be added as structured annotation. For that purpose you have access to the OME schema via vectorized embeddings.
        Furthermore to improve the consistency of the ouput, you have acess to the SepOutputTool which will structure the output key value pairs appropriately.
        ALWAYS USE THE TOOL TO PRODUCE RELIABLE OUTPUTS.
        The tool has two fields, annotation_properties and ome_properties. The annotation_properties are the properties that should be added as structured annotations.
        The ome_properties are the key value pairs that are represented in the OME Datamodel model.
        If you understood all of this, and will follow the instructions, answer with &#34;.&#34; and wait for the first metadata to be provided.
        &#34;&#34;&#34;

    
    def predict(self) -&gt; StructuredAnnotations:
        &#34;&#34;&#34;
        TODO: Add docstring
        &#34;&#34;&#34;
        self.init_sep_thread()
        self.init_vector_store()
        self.init_sep_assistant()   
        self.init_sep_run()
        self.sep_response = self.sep_run.required_action.submit_tool_outputs.tool_calls[0].function.arguments
        sep_cost = self.get_cost(self.sep_run)
        self.sep_response = ast.literal_eval(self.sep_response)
        sep_response_annot = self.sep_response[&#34;annotation_properties&#34;]
        sep_response_ome = self.sep_response[&#34;ome_properties&#34;]

        self.pred_response_annot, annot_cost, annot_attempts = PredictorXMLAnnotation(&#34;Here is the preselected raw metadata \n&#34; + str(sep_response_annot)).predict()
        self.pred_response_ome, ome_cost, ome_attempts = PredictorSimple(&#34;Here is the preselected raw metadata \n&#34; + str(sep_response_ome)).predict()
        # merge
        print(self.pred_response_annot)
        xml_annotation = utils.dict_to_xml_annotation(self.pred_response_annot)
        ome_xml = from_xml(self.pred_response_ome)
        ome_xml.structured_annotations.append(xml_annotation)

        cost = sep_cost + annot_cost + ome_cost
        self.clean_assistants()
        return to_xml(ome_xml), cost, np.mean([annot_attempts, ome_attempts])
    
    def init_sep_run(self):
        self.sep_run = self.client.beta.threads.runs.create(
            thread_id=self.sep_thread.id,
            assistant_id=self.sep_assistant.id,
            tool_choice={&#34;type&#34;: &#34;file_search&#34;, &#34;type&#34;: &#34;function&#34;, &#34;function&#34;: {&#34;name&#34;: &#34;SepOutputTool&#34;}},
            temperature=0.0,
            )
        
        end_status = [&#34;complete&#34;, &#34;requires_action&#34;, &#34;failed&#34;]
        while self.sep_run.status not in end_status:
            print(self.sep_run.status)
            time.sleep(5)
            self.sep_run = self.client.beta.threads.runs.retrieve(
                thread_id=self.sep_thread.id,
                run_id=self.sep_run.id
                )
            
        print(self.sep_run.status)


    def init_sep_assistant(self):
        self.sep_assistant = self.client.beta.assistants.create(
            name=&#34;OME XML Seperator&#34;,
            description=&#34;An assistant to seperate raw metadata into already contained and new metadata. Use the knowledge base of the omexml schema, to make the best decsion&#34;,
            instructions=self.sep_prompt,
            model=&#34;gpt-4o&#34;,
            tools=[{&#34;type&#34;: &#34;file_search&#34;}, utils.openai_schema(self.SepOutputTool)],
            tool_resources={&#34;file_search&#34;: {&#34;vector_store_ids&#34;: [self.vector_store.id]}}
        )
        self.assistants.append(self.sep_assistant)

    
    def init_vector_store(self):
        self.vector_store = self.client.beta.vector_stores.create(
            name=&#34;OME XML Schema&#34;,
        )
        file_paths = [&#34;/home/aaron/Documents/Projects/MetaGPT/in/schema/ome_xsd.txt&#34;]
        file_streams = [open(path, &#34;rb&#34;) for path in file_paths]

        file_batch = self.client.beta.vector_stores.file_batches.upload_and_poll(
            vector_store_id=self.vector_store.id, files=file_streams
            )
        self.vector_stores.append(self.vector_store)
        
    def init_sep_thread(self):
        self.sep_thread = self.client.beta.threads.create(messages=[
            {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: self.sep_prompt},
            {&#34;role&#34;: &#34;assistant&#34;, &#34;content&#34;: &#34;.&#34;},
            {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: self.full_message}])
        self.threads.append(self.sep_thread)
    

    class SepOutputTool(BaseModel):
        &#34;&#34;&#34;
        This tool automatically formats and structures the metadata in the appropriate way.
        &#34;&#34;&#34;
        annotation_properties: Optional[dict[str, str]] = Field(default_factory=list, description=&#34;A list of properties which are to be put into the structured annotations.&#34;)
        ome_properties: Optional[dict[str, str]] = Field(default_factory=list, description=&#34;A list of properties which are already contained in the OME model.&#34;)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="src.metagpt.predictors.predictor_template.PredictorTemplate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate">PredictorTemplate</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.SepOutputTool"><code class="name">var <span class="ident">SepOutputTool</span></code></dt>
<dd>
<div class="desc"><p>This tool automatically formats and structures the metadata in the appropriate way.</p></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_assistant"><code class="name flex">
<span>def <span class="ident">init_sep_assistant</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_run"><code class="name flex">
<span>def <span class="ident">init_sep_run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_thread"><code class="name flex">
<span>def <span class="ident">init_sep_thread</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.init_vector_store"><code class="name flex">
<span>def <span class="ident">init_vector_store</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_network.PredictorNetwork.predict"><code class="name flex">
<span>def <span class="ident">predict</span></span>(<span>self) ‑> ome_types._autogenerated.ome_2016_06.structured_annotations.StructuredAnnotations</span>
</code></dt>
<dd>
<div class="desc"><p>TODO: Add docstring</p></div>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="src.metagpt.predictors.predictor_template.PredictorTemplate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate">PredictorTemplate</a></b></code>:
<ul class="hlist">
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.clean_assistants" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.clean_assistants">clean_assistants</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.export_ome_xml" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.export_ome_xml">export_ome_xml</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.generate_message" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.generate_message">generate_message</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.get_cost" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.get_cost">get_cost</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.get_response" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.get_response">get_response</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.init_thread" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.init_thread">init_thread</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_string" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_string">read_ome_as_string</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_xml" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_xml">read_ome_as_xml</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_raw_metadata" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_raw_metadata">read_raw_metadata</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.subdivide_raw_metadata" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.subdivide_raw_metadata">subdivide_raw_metadata</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.validate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.validate">validate</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="src.metagpt.predictors" href="index.html">src.metagpt.predictors</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork" href="#src.metagpt.predictors.predictor_network.PredictorNetwork">PredictorNetwork</a></code></h4>
<ul class="two-column">
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.SepOutputTool" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.SepOutputTool">SepOutputTool</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_assistant" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_assistant">init_sep_assistant</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_run" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_run">init_sep_run</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_thread" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.init_sep_thread">init_sep_thread</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.init_vector_store" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.init_vector_store">init_vector_store</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_network.PredictorNetwork.predict" href="#src.metagpt.predictors.predictor_network.PredictorNetwork.predict">predict</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>

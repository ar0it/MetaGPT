<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.1">
<title>src.metagpt.predictors.predictor_simple API documentation</title>
<meta name="description" content="">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>src.metagpt.predictors.predictor_simple</code></h1>
</header>
<section id="section-intro">
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple"><code class="flex name class">
<span>class <span class="ident">PredictorSimple</span></span>
<span>(</span><span>raw_meta: str)</span>
</code></dt>
<dd>
<div class="desc"><p>TODO: Add docstring</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class PredictorSimple(PredictorTemplate):
    &#34;&#34;&#34;
    TODO: Add docstring
    &#34;&#34;&#34;
    def __init__(self, raw_meta: str) -&gt; None:
        super().__init__()
        self.raw_metadata = raw_meta
        self.full_message = &#34;The raw data is: \n&#34; + str(self.raw_metadata)
        self.prompt = &#34;&#34;&#34;
        You are part of a toolchain designed to predict metadata for the OME model, specifically the structured annotations part.
        You will be interacting with other toolchain components, therefore asking questions or providing any human-readable output is not necessary.
        You should concisely and structured document your thought process for logging purposes. mark those as &#34;thoughts&#34;.
        The toolchain is a Tree structure of models, designed with the OME schema in mind.
        This means each node has a predictor such as yourself, and will be predicting the metadata for a submodel of the OME schema.
        One such submodel could be the  XMLAnnotation node.
        The tree structure is designed to predict the metadata in a bottom-up manner, starting from the lower level node.
        This way there are no missing dependencies when predicting the metadata.
        Incoming metadata will be provided in raw format, which means a list of key-value pairs.
        Your task will be to translate these key-value pairs to the appropriate OME schema property.
        Try to figure out which property is which by looking at the schema and the raw metadata in a holistic manner.
        The function call arguments you were given are the corresponding schema snippet you are supposed to fill out, remember only the highest level; the lower levels provided are only for validation and context.
        Since this is a hard problem, I will need you to think step by step and use chain of thought.
        Here is the structure of how to approach the problem step by step:
        1. Look at the raw metadata, which properties can not be served by the ome data model and therefore should be added as structured annotations?
        2. Figure out if you can groupt these properties in a hierarchical manner, do they cluster together?
        3. Come to a conclusion how you want to structure the metadata.
        4. Call the XMLAnnotationFunction function with the structured annotations as xml Json.
        It is very well possible some fields remain empty.
        Remember to solve this problem step by step and use chain of thought to solve it.
        Again, you are not interacting with a human but are part of a chain of tools that are supposed to solve this problem.
        Under no circumstances can you ask questions.
        You will have to decide on your own. ONLY EVER RESPOND WITH THE JSON FUNCTION CALL.
        If you understood all of this, and will follow the instructions, answer with &#34;.&#34; and wait for the first metadata to be provided.
        Use the provided function to solve the task. YOU NEED TO CALL THE FUNCTION TO SOLVE THE TASK. The chat response will be ignored.
        &#34;&#34;&#34;
        self.pred_prompt = &#34;&#34;&#34;
        You are a tool designed to predict metadata for the OME
        model.
        Your task will be to take raw metadata in the form of a dictionary of key-value pairs
        and put them into well formed OME XML.
        The goal here is to understand the meaning of the key value pairs and infer the correct ome properties.
        Importantly, always structure the metadata to follow the ome datamodel.
        Try to understnad exactly how the metadata properties are
        related to each other and make sense of them.
        Try to figure out a good structure by looking at the raw metadata in a
        holistic manner.
        Furthermore a file search function is provided with which you can 
        look at the ome schema to make sure you produce valid metadata.
        Always use the tool to get reliable results.
        Since this is a hard problem, I will need you to think step by step and use chain of thought.
        Before you produce actual metadata, carefully analyze the probmlem, come up with a plan and structure.
        Here is the structure of how to approach the problem step by step:
        1. Look at the ome xml schema.
        2. Look at the raw metadata.
        3. Which proerties from the key value pairs map to which ome properties?
        4. Discard any properties that are not part of the ome schema.
        5. Generate the well formed ome xml
        Remember to solve this problem step by step and use chain of thought to solve it.
        You are not interacting with a human but are part of a larger pipeline, therefore you dont need to &#34;chat&#34;.
        Under no circumstances can you ask questions.
        To return your response use the OMEXMLResponse function, which helps you to create a consistent output.
        The OMEXMLResponse function has a ome_xml field, which you should fill with the well formed OME XML.
        ALWAYS USE THE FUNCTION TO PRODUCE RELIABLE OUTPUTS.
        You will have to decide on your own. ONLY EVER RESPOND WITH THE WELL FORMED OME XML.
        Use the provided functions to solve the task. YOU NEED TO CALL THE FUNCTIONs TO SOLVE THE TASK. The chat response will be ignored.
        If you understood all of this, and will follow the instructions, answer with &#34;.&#34; and wait for the metadata to be provided.
        &#34;&#34;&#34;

    
    def predict(self) -&gt; dict:
        &#34;&#34;&#34;
        TODO: Add docstring
        &#34;&#34;&#34;
        self.init_thread()
        self.init_vector_store()
        self.init_assistant()   
        self.init_run()
        if self.run.status == &#39;completed&#39;:
            response = self.client.beta.threads.messages.list(
                thread_id=self.thread.id
            )
            response = response.data[0].content[0].text.value[7:][:-4]
            cost = self.get_cost(run=self.run)
        elif self.run.status == &#39;requires_action&#39;:
            response = self.run.required_action.submit_tool_outputs.tool_calls[0]
            response = ast.literal_eval(response.function.arguments)
            response = response[&#39;ome_xml&#39;]
            cost = self.get_cost(run=self.run)

        try:
            test_ome_pred = from_xml(response)

        except Exception as e:
            print(e)
            if self.attempts &lt; 4:
                self.attempts += 1
                return self.predict()
            else:
                raise ValueError(&#34;Could not convert the OME XML to OME object&#34;)
        

        self.clean_assistants()        
        return response, cost, self.attempts
    
    def init_run(self):
        self.run = self.client.beta.threads.runs.create(
            thread_id=self.thread.id,
            assistant_id=self.assistant.id,
            tool_choice={&#34;type&#34;: &#34;file_search&#34;, &#34;type&#34;: &#34;function&#34;, &#34;function&#34;: {&#34;name&#34;: &#34;OMEXMLResponse&#34;}},
            temperature=0.0,
            )
        
        end_status = [&#34;completed&#34;, &#34;requires_action&#34;, &#34;failed&#34;]
        while self.run.status not in end_status:
            print(self.run.status)
            time.sleep(5)
            self.run = self.client.beta.threads.runs.retrieve(
                thread_id=self.thread.id,
                run_id=self.run.id
                )
            
        print(self.run.status)
        
    def init_assistant(self):
        self.assistant = self.client.beta.assistants.create(
            name=&#34;OME XML Annotator&#34;,
            description=&#34;An assistant to predict OME XML annotations from raw metadata&#34;,
            instructions=self.pred_prompt,
            model=&#34;gpt-4o&#34;,
            tools=[{&#34;type&#34;: &#34;file_search&#34;}, utils.openai_schema(self.OMEXMLResponse)],
            tool_resources={&#34;file_search&#34;: {&#34;vector_store_ids&#34;: [self.vector_store.id]}}
        )
        self.assistants.append(self.assistant)

    def init_thread(self):
        self.thread = self.client.beta.threads.create(messages=[{&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: self.pred_prompt},
                                                                {&#34;role&#34;: &#34;assistant&#34;, &#34;content&#34;: &#34;.&#34;},
                                                                {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: self.full_message}])
        self.threads.append(self.thread)

    def init_vector_store(self):
        self.vector_store = self.client.beta.vector_stores.create(
            name=&#34;OME XML Schema&#34;,
        )
        file_paths = [&#34;/home/aaron/Documents/Projects/MetaGPT/in/schema/ome_xsd.txt&#34;]
        file_streams = [open(path, &#34;rb&#34;) for path in file_paths]

        file_batch = self.client.beta.vector_stores.file_batches.upload_and_poll(
            vector_store_id=self.vector_store.id, files=file_streams
            )
        self.vector_stores.append(self.vector_store)

    class OMEXMLResponse(BaseModel):
        &#34;&#34;&#34;
        The response to the OME XML annotation
        &#34;&#34;&#34;
        ome_xml: Optional[str] = Field(None, description=&#34;The well formed OME XML starting with &lt;OME&gt; and ending with &lt;/OME&gt;&#34;)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="src.metagpt.predictors.predictor_template.PredictorTemplate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate">PredictorTemplate</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple.OMEXMLResponse"><code class="name">var <span class="ident">OMEXMLResponse</span></code></dt>
<dd>
<div class="desc"><p>The response to the OME XML annotation</p></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple.init_assistant"><code class="name flex">
<span>def <span class="ident">init_assistant</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple.init_run"><code class="name flex">
<span>def <span class="ident">init_run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple.init_vector_store"><code class="name flex">
<span>def <span class="ident">init_vector_store</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt id="src.metagpt.predictors.predictor_simple.PredictorSimple.predict"><code class="name flex">
<span>def <span class="ident">predict</span></span>(<span>self) ‑> dict</span>
</code></dt>
<dd>
<div class="desc"><p>TODO: Add docstring</p></div>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="src.metagpt.predictors.predictor_template.PredictorTemplate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate">PredictorTemplate</a></b></code>:
<ul class="hlist">
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.clean_assistants" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.clean_assistants">clean_assistants</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.export_ome_xml" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.export_ome_xml">export_ome_xml</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.generate_message" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.generate_message">generate_message</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.get_cost" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.get_cost">get_cost</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.get_response" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.get_response">get_response</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.init_thread" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.init_thread">init_thread</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_string" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_string">read_ome_as_string</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_xml" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_ome_as_xml">read_ome_as_xml</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.read_raw_metadata" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.read_raw_metadata">read_raw_metadata</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.subdivide_raw_metadata" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.subdivide_raw_metadata">subdivide_raw_metadata</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_template.PredictorTemplate.validate" href="predictor_template.html#src.metagpt.predictors.predictor_template.PredictorTemplate.validate">validate</a></code></li>
</ul>
</li>
</ul>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="src.metagpt.predictors" href="index.html">src.metagpt.predictors</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple" href="#src.metagpt.predictors.predictor_simple.PredictorSimple">PredictorSimple</a></code></h4>
<ul class="">
<li><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple.OMEXMLResponse" href="#src.metagpt.predictors.predictor_simple.PredictorSimple.OMEXMLResponse">OMEXMLResponse</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple.init_assistant" href="#src.metagpt.predictors.predictor_simple.PredictorSimple.init_assistant">init_assistant</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple.init_run" href="#src.metagpt.predictors.predictor_simple.PredictorSimple.init_run">init_run</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple.init_vector_store" href="#src.metagpt.predictors.predictor_simple.PredictorSimple.init_vector_store">init_vector_store</a></code></li>
<li><code><a title="src.metagpt.predictors.predictor_simple.PredictorSimple.predict" href="#src.metagpt.predictors.predictor_simple.PredictorSimple.predict">predict</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.1</a>.</p>
</footer>
</body>
</html>
